external_components:
  - source:
      type: git
      url: https://github.com/AlteroAscension/esphome-dynamixel
      ref: main
    components: [dynamixel]

esphome:
  name: xm430_demo
  platform: ESP32
  board: esp32dev

logger:

uart:
  id: uart_dxl
  tx_pin: 17
  rx_pin: 16
  baud_rate: 57600

dynamixel:
  id: dxl
  uart_id: uart_dxl
  protocol: 2
  direction_pin: 4
  devices:
    - name: "xm430"
      device_id: 1
      protocol: 2
      registers:
        - { name: "operating_mode", address: 11, length: 1, access: "rw" }
        - { name: "torque_enable", address: 64, length: 1, access: "rw" }
        - { name: "led", address: 65, length: 1, access: "rw" }
        - { name: "velocity_limit", address: 44, length: 4, access: "rw" }
        - { name: "profile_acceleration", address: 108, length: 4, access: "rw" }
        - { name: "profile_velocity", address: 112, length: 4, access: "rw" }
        - { name: "goal_velocity", address: 104, length: 4, access: "rw" }
        - { name: "goal_position", address: 116, length: 4, access: "rw" }
        - { name: "present_current", address: 126, length: 2, access: "r" }
        - { name: "present_velocity", address: 128, length: 4, access: "r" }
        - { name: "present_position", address: 132, length: 4, access: "r" }
        - { name: "present_input_voltage", address: 144, length: 2, access: "r" }
        - { name: "position_d_gain", address: 80, length: 2, access: "rw" }
        - { name: "position_i_gain", address: 82, length: 2, access: "rw" }
        - { name: "position_p_gain", address: 84, length: 2, access: "rw" }

switch:
  - platform: dynamixel
    name: "XM430 Torque"
    dynamixel_id: dxl
    dxl_device_id: 1
    register: "torque_enable"

  - platform: dynamixel
    name: "XM430 LED"
    dynamixel_id: dxl
    dxl_device_id: 1
    register: "led"

select:
  - platform: dynamixel
    name: "XM430 Operating Mode"
    dynamixel_id: dxl
    dxl_device_id: 1
    register: "operating_mode"
    options:
      - { name: "Velocity (1)", value: 1 }
      - { name: "Position (3)", value: 3 }
      - { name: "Extended Position (4)", value: 4 }
      - { name: "PWM (16)", value: 16 }

number:
  - platform: dynamixel
    name: "XM430 Goal Position (deg)"
    dynamixel_id: dxl
    dxl_device_id: 1
    register: "goal_position"
    min_value: -3600
    max_value: 3600
    step: 1
    multiply: 11.3777778

sensor:
  - platform: dynamixel
    name: "XM430 Present Position"
    dynamixel_id: dxl
    dxl_device_id: 1
    register: "present_position"
    update_interval: 200ms
    unit_of_measurement: "ticks"

  - platform: dynamixel
    name: "XM430 Present Velocity"
    dynamixel_id: dxl
    dxl_device_id: 1
    register: "present_velocity"
    update_interval: 200ms

  - platform: dynamixel
    name: "XM430 Present Current"
    dynamixel_id: dxl
    dxl_device_id: 1
    register: "present_current"
    update_interval: 500ms
    signed: true
    multiply: 2.69
    unit_of_measurement: "mA"

  - platform: dynamixel
    name: "XM430 Present Voltage"
    dynamixel_id: dxl
    dxl_device_id: 1
    register: "present_input_voltage"
    update_interval: 1s
    multiply: 0.1
    unit_of_measurement: "V"
